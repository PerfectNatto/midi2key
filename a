#include <executorch/runtime/runtime.h>
#include <executorch/extension/runner_util/executor_runner.h>   // 静的ビルドで有効
#include <executorch/extension/data_loader/file_data_loader.h>

extern "C"
int run_pte(const char* pte_path) {
    using namespace torch::executorch;
    extension::FileDataLoader loader(pte_path);
    auto maybe_program = runtime::load_program(std::move(loader));
    if (!maybe_program.ok()) return -1;

    auto program = std::move(*maybe_program);
    runtime::Executor executor;
    if (!executor.open(program).ok()) return -2;

    // 入力は例としてすべて 0 のバッファを渡す
    float dummy_in[1 * 3 * 224 * 224] = {0};
    extension::Tensor input = extension::from_blob(
        dummy_in, {1, 3, 224, 224});

    // method “forward” は XNNPACK で delegate 済みのはず
    executor.set_input(0, input);
    if (!executor.run().ok()) return -3;

    auto out = executor.get_output(0);
    return out.template const_data_ptr<float>()[0] > 0 ? 0 : 0;
}
