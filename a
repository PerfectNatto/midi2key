import boto3
from tqdm import tqdm

class ProgressPercentage:
    def __init__(self, bucket: str, key: str):
        s3 = boto3.client('s3')
        size = s3.head_object(Bucket=bucket, Key=key)['ContentLength']
        self._bar = tqdm(total=size, unit='B', unit_scale=True, desc=key.split('/')[-1])

    def __call__(self, bytes_amount):
        self._bar.update(bytes_amount)

    def close(self):
        self._bar.close()

def download_with_tqdm(bucket: str, key: str, dest: str):
    s3 = boto3.client('s3')
    prog = ProgressPercentage(bucket, key)
    try:
        s3.download_file(Bucket=bucket, Key=key, Filename=dest, Callback=prog)
    finally:
        prog.close()

# 使い方例
if __name__ == "__main__":
    BUCKET = "your-bucket-name"
    KEY = "path/to/file.zip"
    DEST = "./file.zip"
    download_with_tqdm(BUCKET, KEY, DEST)
